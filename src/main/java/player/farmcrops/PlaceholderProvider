package player.farmcrops;

import me.clip.placeholderapi.PlaceholderExpansion;
import org.bukkit.entity.Player;
import org.bukkit.inventory.ItemStack;
import org.bukkit.persistence.PersistentDataContainer;
import org.bukkit.persistence.PersistentDataType;

public class PlaceholderProvider extends PlaceholderExpansion {

    private final FarmCrops plugin;

    public PlaceholderProvider(FarmCrops plugin) {
        this.plugin = plugin;
    }

    @Override
    public String getIdentifier() {
        return "farmcrops";
    }

    @Override
    public String getAuthor() {
        return "Player";
    }

    @Override
    public String getVersion() {
        return "0.4.0";
    }

    @Override
    public String onPlaceholderRequest(Player player, String placeholder) {
        // Find the first FarmCrops item the player is holding or has selected
        // We check the item in the player's main hand first, then off hand
        ItemStack item = getHeldCropItem(player);

        switch (placeholder.toLowerCase()) {
            case "price":
                if (item == null) return "0.00";
                return String.format("%.2f", calculatePrice(item));

            case "tier":
                if (item == null) return "None";
                return CropListener.capitalize(getTier(item));

            case "weight":
                if (item == null) return "0.00";
                return String.format("%.2f", getWeight(item));

            case "crop":
                if (item == null) return "None";
                return getCropName(item);

            case "tier_multiplier":
                if (item == null) return "1.00";
                String tier = getTier(item);
                return String.format("%.2f", plugin.getConfig().getDouble("tiers." + tier + ".multiplier", 1.0));

            case "base_price":
                return String.format("%.2f", plugin.getConfig().getDouble("prices.default", 1.0));

            default:
                return null; // Unknown placeholder
        }
    }

    // ---------------------------------------------------------------
    // Helpers
    // ---------------------------------------------------------------
    private ItemStack getHeldCropItem(Player player) {
        // Check main hand first
        ItemStack mainHand = player.getEquipped(org.bukkit.equipment.EquipmentSlot.HAND);
        if (isFarmCropItem(mainHand)) return mainHand;

        // Then off hand
        ItemStack offHand = player.getEquipped(org.bukkit.equipment.EquipmentSlot.OFF_HAND);
        if (isFarmCropItem(offHand)) return offHand;

        return null;
    }

    private boolean isFarmCropItem(ItemStack item) {
        if (item == null || item.getType().isAir() || !item.hasItemMeta()) return false;
        return item.getItemMeta().getPersistentDataContainer()
                .has(CropListener.WEIGHT_KEY, PersistentDataType.DOUBLE);
    }

    private double getWeight(ItemStack item) {
        return item.getItemMeta().getPersistentDataContainer()
                .get(CropListener.WEIGHT_KEY, PersistentDataType.DOUBLE);
    }

    private String getTier(ItemStack item) {
        return item.getItemMeta().getPersistentDataContainer()
                .getOrDefault(CropListener.TIER_KEY, PersistentDataType.STRING, "common");
    }

    private String getCropName(ItemStack item) {
        PersistentDataContainer pdc = item.getItemMeta().getPersistentDataContainer();
        if (pdc.has(CropListener.CROP_KEY, PersistentDataType.STRING)) {
            return pdc.get(CropListener.CROP_KEY, PersistentDataType.STRING);
        }
        // Fallback: derive from material
        return CropListener.formatName(item.getType());
    }

    private double calculatePrice(ItemStack item) {
        double weight        = getWeight(item);
        String tier          = getTier(item);
        double basePrice     = plugin.getConfig().getDouble("prices.default", 1.0);
        double tierMultiplier = plugin.getConfig().getDouble("tiers." + tier + ".multiplier", 1.0);
        return basePrice * tierMultiplier * weight;
    }
}
